# Copyright 2026 The HuggingFace Team. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import os
import subprocess
import sys
import unittest
from pathlib import Path
from unittest.mock import patch


git_repo_path = os.path.abspath(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))
sys.path.append(os.path.join(git_repo_path, "utils"))

import check_modeling_structure as cms  # noqa: E402


class CheckModelingStructureTest(unittest.TestCase):
    def test_trf001_valid_super_init(self):
        source = """
class FooPreTrainedModel:
    def __init__(self, config):
        pass

class FooModel(FooPreTrainedModel):
    def __init__(self, config):
        super().__init__(config)
        self.post_init()
"""
        file_path = Path("src/transformers/models/foo/modeling_foo.py")
        violations = cms.analyze_file(file_path, source)
        trf001 = [violation for violation in violations if violation.rule_id == cms.TRF001]
        self.assertEqual(trf001, [])

    def test_trf001_invalid_missing_parent_init(self):
        source = """
class FooPreTrainedModel:
    def __init__(self, config):
        pass

class FooModel(FooPreTrainedModel):
    def __init__(self, config):
        self.post_init()
"""
        file_path = Path("src/transformers/models/foo/modeling_foo.py")
        violations = cms.analyze_file(file_path, source)
        trf001 = [violation for violation in violations if violation.rule_id == cms.TRF001]
        self.assertEqual(len(trf001), 1)
        self.assertEqual(trf001[0].line_number, 7)
        self.assertIn("must initialize a PreTrainedModel parent", trf001[0].message)

    def test_trf001_supports_class_suppression(self):
        source = """
class FooPreTrainedModel:
    def __init__(self, config):
        pass

# trf-ignore: TRF001
class FooModel(FooPreTrainedModel):
    def __init__(self, config):
        self.post_init()
"""
        file_path = Path("src/transformers/models/foo/modeling_foo.py")
        violations = cms.analyze_file(file_path, source)
        trf001 = [violation for violation in violations if violation.rule_id == cms.TRF001]
        self.assertEqual(trf001, [])

    def test_trf002_valid_banner(self):
        modular_file = Path("src/transformers/models/foo/modular_foo.py")
        modeling_file = Path("src/transformers/models/foo/modeling_foo.py")
        source_lines = [
            "# ðŸš¨",
            "# This file was automatically generated from src/transformers/models/foo/modular_foo.py.",
            "# Do NOT edit this file manually as any edits will be overwritten.",
        ]
        violation = cms.check_generated_modeling_banner(modular_file, modeling_file, source_lines)
        self.assertIsNone(violation)

    def test_trf002_invalid_missing_banner(self):
        modular_file = Path("src/transformers/models/foo/modular_foo.py")
        modeling_file = Path("src/transformers/models/foo/modeling_foo.py")
        source_lines = ["# regular file", "class Foo: pass"]
        violation = cms.check_generated_modeling_banner(modular_file, modeling_file, source_lines)
        self.assertIsNotNone(violation)
        self.assertEqual(violation.rule_id, cms.TRF002)
        self.assertEqual(violation.line_number, 1)

    def test_trf010_catches_singular_past_key_value_without_usage(self):
        source = """
class FooPreTrainedModel:
    pass

class FooModel(FooPreTrainedModel):
    def forward(self, hidden_states, past_key_value=None, use_cache=False):
        return hidden_states
"""
        file_path = Path("src/transformers/models/foo/modeling_foo.py")
        violations = cms.analyze_file(file_path, source, enabled_rules={cms.TRF010})
        trf010 = [violation for violation in violations if violation.rule_id == cms.TRF010]
        self.assertEqual(len(trf010), 1)
        self.assertIn("past_key_values/use_cache", trf010[0].message)

    def test_trf013_flags_cross_model_import_in_modeling_file(self):
        source = """
from transformers.models.llama.modeling_llama import LlamaAttention
"""
        file_path = Path("src/transformers/models/foo/modeling_foo.py")
        violations = cms.analyze_file(file_path, source, enabled_rules={cms.TRF013})
        trf013 = [violation for violation in violations if violation.rule_id == cms.TRF013]
        self.assertEqual(len(trf013), 1)
        self.assertIn("imports implementation code from `llama`", trf013[0].message)

    def test_trf013_allows_same_model_import_in_modeling_file(self):
        source = """
from .configuration_foo import FooConfig
from transformers.models.foo.configuration_foo import FooConfig as FooConfigAlias
"""
        file_path = Path("src/transformers/models/foo/modeling_foo.py")
        violations = cms.analyze_file(file_path, source, enabled_rules={cms.TRF013})
        trf013 = [violation for violation in violations if violation.rule_id == cms.TRF013]
        self.assertEqual(trf013, [])

    def test_trf013_ignores_modular_files(self):
        source = """
from transformers.models.llama.modeling_llama import LlamaAttention
"""
        file_path = Path("src/transformers/models/foo/modular_foo.py")
        violations = cms.analyze_file(file_path, source, enabled_rules={cms.TRF013})
        trf013 = [violation for violation in violations if violation.rule_id == cms.TRF013]
        self.assertEqual(trf013, [])

    @patch("check_modeling_structure.subprocess.run")
    def test_get_changed_modeling_files_filters_non_model_files(self, mock_run):
        mock_run.return_value = subprocess.CompletedProcess(
            args=["git", "diff"],
            returncode=0,
            stdout=(
                "src/transformers/models/foo/modeling_foo.py\n"
                "src/transformers/models/foo/modular_foo.py\n"
                "src/transformers/models/foo/configuration_foo.py\n"
                "docs/source/en/index.md\n"
            ),
            stderr="",
        )
        changed_files = cms.get_changed_modeling_files("origin/main")
        self.assertEqual(
            changed_files,
            {
                Path("src/transformers/models/foo/modeling_foo.py"),
                Path("src/transformers/models/foo/modular_foo.py"),
            },
        )


if __name__ == "__main__":
    unittest.main()
