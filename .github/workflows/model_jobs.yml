name: model jobs
on:
  workflow_call:
    inputs:
      folder_slices:
        required: true
        type: string
      machine_type:
        required: true
        type: string
      slice_id:
        required: true
        type: number
      runner:
        required: true
        type: string
      docker:
        required: true
        type: string
env:
  HF_HOME: /mnt/cache
  TRANSFORMERS_IS_CI: yes
  OMP_NUM_THREADS: 8
  MKL_NUM_THREADS: 8
  RUN_SLOW: yes
  HF_HUB_READ_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}
  SIGOPT_API_TOKEN: ${{ secrets.SIGOPT_API_TOKEN }}
  TF_FORCE_GPU_ALLOW_GROWTH: true
  RUN_PT_TF_CROSS_TESTS: 1
  CUDA_VISIBLE_DEVICES: 0,1
jobs:
  run_models_gpu:
    name: ' '
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        folders: ${{ fromJson(inputs.folder_slices)[inputs.slice_id] }}
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.docker }}
      options: --gpus all --shm-size "16gb" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/
    steps:
    - name: Echo input and matrix info
      shell: bash
      run: 'echo "${{ inputs.folder_slices }}"

        echo "${{ matrix.folders }}"

        echo "${{ toJson(fromJson(inputs.folder_slices)[inputs.slice_id]) }}"

        '
    - name: Echo folder ${{ matrix.folders }}
      shell: bash
      run: 'echo "${{ matrix.folders }}"

        matrix_folders=${{ matrix.folders }}

        matrix_folders=${matrix_folders/''models/''/''models_''}

        echo "$matrix_folders"

        echo "matrix_folders=$matrix_folders" >> $GITHUB_ENV

        '
    - name: Update clone
      working-directory: /transformers
      run: git fetch && git checkout ${{ github.sha }}
    - name: Reinstall transformers in edit mode (remove the one installed during docker
        image build)
      working-directory: /transformers
      run: python3 -m pip uninstall -y transformers && python3 -m pip install -e .
    - name: Update / Install some packages (for Past CI)
      if: ${{ contains(inputs.docker, '-past-') }}
      working-directory: /transformers
      run: 'python3 -m pip install -U datasets

        '
    - name: Update / Install some packages (for Past CI)
      if: ${{ contains(inputs.docker, '-past-') && contains(inputs.docker, '-pytorch-')
        }}
      working-directory: /transformers
      run: 'python3 -m pip install --no-cache-dir git+https://github.com/huggingface/accelerate@main#egg=accelerate

        '
    - name: update huggingface_hub cli
      run: 'python3 -m pip install -U git+https://github.com/huggingface/huggingface_hub.git@main

        '
    - name: update datasets
      run: 'python3 -m pip install -U git+https://github.com/huggingface/datasets.git@dummy

        '
    - name: NVIDIA-SMI
      run: 'nvidia-smi

        '
    - name: Environment
      working-directory: /transformers
      run: 'python3 utils/print_env.py

        '
    - name: Show installed libraries and their versions
      working-directory: /transformers
      run: pip freeze
    - name: Run python script
      working-directory: /transformers
      run: python3 -m pytest -rsfE -v --make-reports=aws-g4dn-2xlarge-cache-test_run_models_gpu_models/beit_test_reports
        tests/models/beit
