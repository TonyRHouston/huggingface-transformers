name: CircleCI Failure Summary Comment
on:
  pull_request_target:
    types:
    - opened
    - synchronize
    - reopened
jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      TARGET_BRANCH: ${{ github.event.pull_request.head.ref }}
      TARGET_SHA: ${{ github.event.pull_request.head.sha }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Install dependencies
      run: python -m pip install huggingface_hub
    - name: Wait for CircleCI check suite completion
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: "# Exit on error, undefined variables, or pipe failures\nset -euo pipefail\n\
        \necho \"Waiting for CircleCI check suite to complete...\"\n# Timeout after\
        \ 30 minutes (1800 seconds)\nend=$((SECONDS + 1800))\n\nwhile [ $SECONDS -lt\
        \ $end ]; do\n  # Query GitHub API for check suites associated with this commit\n\
        \  # || echo \"\" allows retry on transient API failures instead of exiting\n\
        \  suite_json=$(gh api \"repos/${GITHUB_REPOSITORY}/commits/${COMMIT_SHA}/check-suites\"\
        \ \\\n    --jq '.check_suites[] | select(.app.slug == \"circleci-checks\"\
        )' || echo \"\")\n  \n  if [ -z \"$suite_json\" ]; then\n    echo \"CircleCI\
        \ check suite not found yet, retrying...\"\n  else\n    status=$(echo \"$suite_json\"\
        \ | jq -r '.status')\n    conclusion=$(echo \"$suite_json\" | jq -r '.conclusion\
        \ // empty')\n    echo \"CircleCI status: $status, conclusion: $conclusion\"\
        \n    \n    # Check suite is done when status is \"completed\" AND conclusion\
        \ is set\n    if [ \"$status\" = \"completed\" ] && [ -n \"$conclusion\" ];\
        \ then\n      echo \"Check suite completed successfully\"\n      exit 0\n\
        \    fi\n  fi\n  \n  # Poll every 20 seconds\n  sleep 20\ndone\n\necho \"\
        ERROR: Timed out waiting for CircleCI check suite\"\nexit 1\n"
    - name: Get CircleCI run's artifacts and upload them to Hub
      id: circleci
      env:
        COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        REPO: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "# Step 1: Get CircleCI check suite ID\necho \"Getting check suites for\
        \ commit ${COMMIT_SHA}...\"\ncheck_suites=$(curl -s -H \"Authorization: token\
        \ ${GITHUB_TOKEN}\" \\\n  \"https://api.github.com/repos/${REPO}/commits/${COMMIT_SHA}/check-suites\"\
        )\n\ncircleci_suite_id=$(echo \"$check_suites\" | jq -r '.check_suites[] |\
        \ select(.app.slug == \"circleci-checks\") | .id' | head -n 1)\necho \"CircleCI\
        \ check suite ID: ${circleci_suite_id}\"\n\n# Step 2: Get check runs from\
        \ the CircleCI suite\necho \"Getting check runs for suite ${circleci_suite_id}...\"\
        \ncheck_runs=$(curl -s -H \"Authorization: token ${GITHUB_TOKEN}\" \\\n  \"\
        https://api.github.com/repos/${REPO}/check-suites/${circleci_suite_id}/check-runs\"\
        )\n\n# Step 3: Extract workflow ID from the \"run_tests\" check run\nworkflow_id=$(echo\
        \ \"$check_runs\" | jq -r '.check_runs[] | select(.name == \"run_tests\")\
        \ | .details_url' | grep -oP 'workflows/\\K[a-f0-9-]+')\necho \"CircleCI Workflow\
        \ ID: ${workflow_id}\"\n\n# Step 4: Get all jobs in the workflow\necho \"\
        Getting jobs for workflow ${workflow_id}...\"\njobs=$(curl -s \\\n  \"https://circleci.com/api/v2/workflow/${workflow_id}/job\"\
        )\n\n# Step 5: Extract collection_job details\ncollection_job_number=$(echo\
        \ \"$jobs\" | jq -r '.items[] | select(.name == \"collection_job\") | .job_number')\n\
        collection_job_id=$(echo \"$jobs\" | jq -r '.items[] | select(.name == \"\
        collection_job\") | .id')\necho \"CircleCI Collection job number: ${collection_job_number}\"\
        \necho \"CircleCI Collection job ID: ${collection_job_id}\"\n\n# Step 6: Get\
        \ artifacts list\necho \"Getting artifacts for job ${collection_job_number}...\"\
        \nartifacts=$(curl -s \\\n  \"https://circleci.com/api/v2/project/gh/${REPO}/${collection_job_number}/artifacts\"\
        )\n\necho \"$artifacts\" | jq '.'\n\n# Step 7: Download failure_summary.json\
        \ specifically\nfailure_summary_url=$(echo \"$artifacts\" | jq -r '.items[]\
        \ | select(.path == \"outputs/failure_summary.json\") | .url')\n\nif [ -z\
        \ \"$failure_summary_url\" ]; then\n  echo \"failure_summary.json not found\
        \ in artifacts - PR may not have latest main merged. Skipping.\"\n  echo \"\
        artifact_found=false\" >> $GITHUB_OUTPUT\n  exit 0\nfi\n\necho \"Downloading\
        \ failure_summary.json from: ${failure_summary_url}\"\nmkdir -p outputs\n\
        curl -s -L \"${failure_summary_url}\" -o outputs/failure_summary.json\nls\
        \ -la outputs\n\necho \"Downloaded failure_summary.json successfully\"\n\n\
        # Verify the file was downloaded\nif [ ! -f outputs/failure_summary.json ];\
        \ then\n  echo \"Failed to download failure_summary.json - skipping.\"\n \
        \ echo \"artifact_found=false\" >> $GITHUB_OUTPUT\n  exit 0\nfi\n\necho \"\
        File size: $(wc -c < outputs/failure_summary.json) bytes\"\n\n# Export variables\
        \ for next steps\necho \"artifact_found=true\" >> $GITHUB_OUTPUT\necho \"\
        workflow_id=${workflow_id}\" >> $GITHUB_OUTPUT\necho \"collection_job_number=${collection_job_number}\"\
        \ >> $GITHUB_OUTPUT\n"
    - name: Upload summaries to Hub
      if: steps.circleci.outputs.artifact_found == 'true'
      env:
        HF_TOKEN: ${{ secrets.HF_CI_WRITE_TOKEN }}
        CIRCLECI_RESULTS_DATASET_ID: transformers-community/circleci-test-results
        PR_NUMBER: ${{ github.event.pull_request.number }}
        COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
      run: "python << 'EOF'\nimport os\nfrom pathlib import Path\nfrom huggingface_hub\
        \ import HfApi\n\n# Setup paths\npr_number = os.environ[\"PR_NUMBER\"]\ncommit_short\
        \ = os.environ[\"COMMIT_SHA\"][:12]\nfolder_path = f\"pr-{pr_number}/sha-{commit_short}\"\
        \n\n# Create folder and move file\nPath(folder_path).mkdir(parents=True, exist_ok=True)\n\
        Path(\"outputs/failure_summary.json\").rename(f\"{folder_path}/failure_summary.json\"\
        )\n\n# Upload to Hub\ndataset_id = os.environ[\"CIRCLECI_RESULTS_DATASET_ID\"\
        ]\napi = HfApi(token=os.environ[\"HF_TOKEN\"])\napi.upload_folder(\n    commit_message=f\"\
        Update CircleCI artifacts for PR {pr_number} ({commit_short})\",\n    folder_path=folder_path,\n\
        \    path_in_repo=folder_path,\n    repo_id=dataset_id,\n    repo_type=\"\
        dataset\",\n)\n\nprint(f\"Uploaded {folder_path} to {dataset_id}\")\nEOF\n"
    - name: Delete existing CircleCI summary comments
      if: steps.circleci.outputs.artifact_found == 'true'
      env:
        PR_NUMBER: ${{ github.event.pull_request.number }}
      uses: actions/github-script@v7
      with:
        script: "const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\n\n// Get\
          \ all comments on the PR\nconst { data: comments } = await github.rest.issues.listComments({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number:\
          \ PR_NUMBER\n});\n\n// Find existing bot comments that start with \"View\
          \ the CircleCI Test Summary for this PR:\"\nconst existingComments = comments.filter(comment\
          \ => \n  comment.user.login === 'github-actions[bot]' && \n  comment.body.startsWith('View\
          \ the CircleCI Test Summary for this PR:')\n);\n\n// Delete all matching\
          \ comments\nfor (const comment of existingComments) {\n  console.log(`Deleting\
          \ comment #${comment.id}`);\n  await github.rest.issues.deleteComment({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    comment_id:\
          \ comment.id\n  });\n}\n\nconsole.log(`Deleted ${existingComments.length}\
          \ old CircleCI summary comment(s)`);\n"
    - name: Post comment with helper link
      if: steps.circleci.outputs.artifact_found == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_SHA: ${{ github.event.pull_request.head.sha }}
      run: "COMMIT_SHORT=\"${PR_SHA:0:12}\"\nSUMMARY_FILE=\"pr-${PR_NUMBER}/sha-${COMMIT_SHORT}/failure_summary.json\"\
        \n\nif [ ! -f \"$SUMMARY_FILE\" ]; then\n  echo \"failure_summary.json missing,\
        \ skipping comment.\"\n  exit 0\nfi\n\nfailures=$(jq '.failures | length'\
        \ \"$SUMMARY_FILE\")\nif [ \"$failures\" -eq 0 ]; then\n  echo \"No failures\
        \ detected, skipping PR comment.\"\n  exit 0\nfi\n\n# Build Space URL with\
        \ encoded parameters\nrepo_enc=$(jq -rn --arg v \"$GITHUB_REPOSITORY\" '$v|@uri')\n\
        pr_enc=$(jq -rn --arg v \"$PR_NUMBER\" '$v|@uri')\nsha_short=\"${PR_SHA:0:6}\"\
        \nsha_enc=$(jq -rn --arg v \"$sha_short\" '$v|@uri')\nSPACE_URL=\"https://huggingface.co/spaces/transformers-community/circle-ci-viz?pr=${pr_enc}&sha=${sha_enc}\"\
        \n\n# Post comment (using printf for proper newlines)\ngh api \\\n  --method\
        \ POST \\\n  -H \"Accept: application/vnd.github+json\" \\\n  -H \"X-GitHub-Api-Version:\
        \ 2022-11-28\" \\\n  \"repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments\"\
        \ \\\n  -f body=\"$(printf \"View the CircleCI Test Summary for this PR:\\\
        n\\n%s\" \"$SPACE_URL\")\""
