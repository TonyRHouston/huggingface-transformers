name: PR comment GitHub CI
on:
  issue_comment:
    types:
    - created
    branches-ignore:
    - main
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}-${{ startsWith(github.event.comment.body,
    'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body,
    'run_slow') }}
  cancel-in-progress: true
permissions: read-all
env:
  HF_HOME: /mnt/cache
  TRANSFORMERS_IS_CI: yes
  OMP_NUM_THREADS: 8
  MKL_NUM_THREADS: 8
  RUN_SLOW: yes
  HF_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}
  TF_FORCE_GPU_ALLOW_GROWTH: true
  CUDA_VISIBLE_DEVICES: 0,1
jobs:
  get-pr-number:
    name: Get PR number
    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('["ydshieh", "ArthurZucker",
      "zucchini-nlp", "molbap", "gante", "LysandreJik", "Cyrilvallez", "Rocketknight1",
      "SunMarc", "eustlb", "MekkCyber", "vasqu", "ivarflakstad", "stevhliu", "ebezzam",
      "remi-or", "itazap", "3outeille", "IlyasMoutawwakil", "tarekziade"]'), github.actor)
      && (startsWith(github.event.comment.body, 'run-slow') || startsWith(github.event.comment.body,
      'run slow') || startsWith(github.event.comment.body, 'run_slow')) }}
    uses: ./.github/workflows/get-pr-number.yml
  get-pr-info:
    name: Get PR commit SHA
    needs: get-pr-number
    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}
    uses: ./.github/workflows/get-pr-info.yml
    with:
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
  check-timestamps:
    name: Check timestamps (security check)
    runs-on: ubuntu-latest
    needs: get-pr-info
    outputs:
      PR_HEAD_SHA: ${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}
      PR_MERGE_SHA: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_SHA }}
    steps:
    - name: Verify `merge_commit` timestamp is older than the issue comment timestamp
      env:
        COMMENT_DATE: ${{ github.event.comment.created_at }}
        PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP
          }}
      run: "COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\necho \"COMMENT_DATE:\
        \ $COMMENT_DATE\"\necho \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\nif [ $COMMENT_TIMESTAMP\
        \ -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n  echo \"Last commit on the pull\
        \ request is newer than the issue comment triggering this run! Abort!\";\n\
        \  exit -1;\nfi\n"
  get-tests:
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - check-timestamps
    outputs:
      models: ${{ steps.models_to_run.outputs.models }}
      quantizations: ${{ steps.models_to_run.outputs.quantizations }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
        ref: refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge
    - name: Verify merge commit SHA
      env:
        VERIFIED_PR_MERGE_SHA: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      run: "PR_MERGE_SHA=$(git log -1 --format=%H)\nif [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA\
        \ ]; then\n  echo \"The merged commit SHA is not the same as the verified\
        \ one! Security issue detected, abort the workflow!\";\n  exit -1;\nfi\n"
    - name: Get models to test
      env:
        PR_COMMENT: ${{ github.event.comment.body }}
      run: 'python -m pip install GitPython

        python utils/pr_slow_ci_models.py --message "$PR_COMMENT" | tee output.txt

        echo "models=$(tail -n 1 output.txt)" >> $GITHUB_ENV

        python utils/pr_slow_ci_models.py --message "$PR_COMMENT" --quantization |
        tee output2.txt

        echo "quantizations=$(tail -n 1 output2.txt)" >> $GITHUB_ENV

        '
    - name: Show models to test
      id: models_to_run
      run: 'echo "$models"

        echo "models=$models" >> $GITHUB_OUTPUT

        echo "$quantizations"

        echo "quantizations=$quantizations" >> $GITHUB_OUTPUT

        '
  report_error_earlier:
    name: Report error earlier
    if: ${{ always() && needs.get-pr-info.result == 'success' && needs.get-tests.result
      != 'success' }}
    needs:
    - get-pr-number
    - get-pr-info
    - get-tests
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Reply to the comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        PREFIX: "[Workflow Run \u2699\uFE0F](https://github.com/${{ github.repository\
          \ }}/actions/runs/${{ github.run_id }})\\n\\n"
        github_repository: ${{ github.repository }}
        pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/issues/${pr_number}/comments\"\
        \ \\\n  -f body=\"$(echo -e \"$PREFIX\")\U0001F494 This comment contains \\\
        `run-slow\\`, but unknown error occurred and [the workflow run]($GITHUB_RUN_URL)\
        \ aborted!\"\n"
  reply_to_comment:
    name: Reply to the comment
    if: ${{ needs.get-tests.outputs.models != '[]'  || needs.get-tests.outputs.quantizations
      != '[]' }}
    needs:
    - get-pr-number
    - get-tests
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Reply to the comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PREFIX: "[Workflow Run \u2699\uFE0F](https://github.com/${{ github.repository\
          \ }}/actions/runs/${{ github.run_id }})"
        INFO: \n\nThis comment contains `run-slow`, running the specified jobs
        BODY: '\n\nmodels: ${{ needs.get-tests.outputs.models }}\nquantizations: ${{
          needs.get-tests.outputs.quantizations }}'
        github_repository: ${{ github.repository }}
        pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/issues/${pr_number}/comments\"\
        \ \\\n  -f body=\"$(echo -e \"$PREFIX\")$(echo -e \"$INFO\"): $(echo -e \"\
        $BODY\")\"\n"
  create_run:
    name: Create run
    needs:
    - check-timestamps
    - reply_to_comment
    permissions:
      statuses: write
    runs-on: ubuntu-latest
    steps:
    - name: Create Run
      id: create_run
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_head_sha: ${{ needs.check-timestamps.outputs.PR_HEAD_SHA }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/statuses/${pr_head_sha}\"\
        \ \\\n  -f \"target_url=$GITHUB_RUN_URL\" -f \"state=pending\" -f \"description=Slow\
        \ CI job\" -f \"context=pytest/custom-tests\"\n"
  model-ci:
    name: Model CI
    if: ${{ needs.get-tests.outputs.models != '[]' }}
    uses: ./.github/workflows/self-scheduled.yml
    needs:
    - get-pr-number
    - check-timestamps
    - get-tests
    - create_run
    with:
      job: run_models_gpu
      slack_report_channel: '#transformers-ci-pr'
      docker: huggingface/transformers-all-latest-gpu
      ci_event: PR Comment CI
      report_repo_id: hf-internal-testing/transformers_pr_ci
      commit_sha: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      subdirs: ${{ needs.get-tests.outputs.models }}
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
    secrets: inherit
  quantization-ci:
    name: Quantization CI
    if: ${{ needs.get-tests.outputs.quantizations != '[]' }}
    uses: ./.github/workflows/self-scheduled.yml
    needs:
    - get-pr-number
    - check-timestamps
    - get-tests
    - create_run
    with:
      job: run_quantization_torch_gpu
      slack_report_channel: '#transformers-ci-pr'
      docker: huggingface/transformers-quantization-latest-gpu
      ci_event: PR Comment CI
      report_repo_id: hf-internal-testing/transformers_pr_ci
      commit_sha: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      subdirs: ${{ needs.get-tests.outputs.quantizations }}
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
    secrets: inherit
  report:
    name: Check & Report
    needs:
    - get-pr-number
    - get-pr-info
    - check-timestamps
    - create_run
    - model-ci
    - quantization-ci
    permissions:
      pull-requests: write
      statuses: write
    if: ${{ always() && needs.create_run.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        pattern: new_failures_with_bad_commit_{run_models_gpu,run_quantization_torch_gpu}
        path: ./new_failures
        merge-multiple: false
    - name: List downloaded artifacts
      run: "echo \"Downloaded artifact files:\"\nif [ -d \"./new_failures/\" ]; then\n\
        \  find ./new_failures/ -type f\nelse\n  echo \"No artifacts downloaded (directory\
        \ doesn't exist)\"\nfi\n"
    - name: Show reports from jobs
      run: "echo \"=== Model CI Report ===\"\nif [ -f \"./new_failures/new_failures_with_bad_commit_run_models_gpu/new_failures_with_bad_commit.json\"\
        \ ]; then\n  cat ./new_failures/new_failures_with_bad_commit_run_models_gpu/new_failures_with_bad_commit.json\n\
        else\n  echo \"No model CI report found\"\nfi\n\necho \"\"\necho \"=== Quantization\
        \ CI Report ===\"\nif [ -f \"./new_failures/new_failures_with_bad_commit_run_quantization_torch_gpu/new_failures_with_bad_commit.json\"\
        \ ]; then\n  cat ./new_failures/new_failures_with_bad_commit_run_quantization_torch_gpu/new_failures_with_bad_commit.json\n\
        else\n  echo \"No quantization CI report found\"\nfi\n"
    - name: Process and filter reports
      run: "# Preprocess with Python\npython3 << 'PYTHON_SCRIPT'\nimport json\nimport\
        \ os\nfrom pathlib import Path\n\ndef count_failures(data):\n  \"\"\"\n  Count\
        \ total number of failures (excluding None commits)\n  \"\"\"\n  total = 0\n\
        \  for model, model_result in data.items():\n      for device, failures in\
        \ model_result.items():\n          # Count failures where commit is not None\n\
        \          total += sum(\n              1 for failure in failures \n     \
        \         if isinstance(failure, dict) and failure.get('bad_commit') is not\
        \ None\n          )\n  return total\n\ndef filter_and_format_report(data):\n\
        \  \"\"\"\n  Filter out entries where commit is `None` (failing tests who\
        \ status is not certain) and format as text\n  \"\"\"\n  lines = []\n  \n\
        \  for model, model_result in data.items():\n      model_lines = []\n    \
        \  for device, failures in model_result.items():\n          \n          filtered_failures\
        \ = [\n              failure for failure in failures \n              if isinstance(failure,\
        \ dict) and failure.get('bad_commit') is not None\n          ]\n\n       \
        \   # Add tests to model lines\n          for idx, failure in enumerate(filtered_failures):\n\
        \              if idx == 0:\n                  job_link = failure['job_link']\n\
        \                  model_lines.append(f\"- [{model}]({job_link}):\")\n\n \
        \             test_name = failure['test']\n              status = failure.get('status',\
        \ '')\n              if \"DIFFERENT error message\" in status:\n         \
        \         indicator = \"(\u274C \u27F9 \u274C)\"\n              else:\n  \
        \                indicator = \"(\u2705 \u27F9 \u274C)\"\n\n              model_lines.append(f\"\
        \    {test_name} {indicator}\")\n\n      if len(model_lines) > 0:\n      \
        \    lines.extend(model_lines)\n          lines.append(\"\")  # Empty line\
        \ between models\n  \n  return \"\\n\".join(lines).strip()\n\n# Read reports\
        \ from downloaded artifact files\nmodel_report_path = Path('./new_failures/new_failures_with_bad_commit_run_models_gpu/new_failures_with_bad_commit.json')\n\
        quant_report_path = Path('./new_failures/new_failures_with_bad_commit_run_quantization_torch_gpu/new_failures_with_bad_commit.json')\n\
        \n# Read URL files if they exist\nmodel_url_path = Path('./new_failures/new_failures_with_bad_commit_run_models_gpu/new_failures_with_bad_commit_url.txt')\n\
        quant_url_path = Path('./new_failures/new_failures_with_bad_commit_run_quantization_torch_gpu/new_failures_with_bad_commit_url.txt')\n\
        \nmodel_url = None\nif model_url_path.exists():\n    with open(model_url_path,\
        \ 'r') as f:\n        model_url = f.read().strip()\n\nquant_url = None\nif\
        \ quant_url_path.exists():\n    with open(quant_url_path, 'r') as f:\n   \
        \     quant_url = f.read().strip()\n\nmodel_report = {}\nif model_report_path.exists():\n\
        \    with open(model_report_path, 'r') as f:\n        model_report = json.load(f)\n\
        \nquant_report = {}\nif quant_report_path.exists():\n    with open(quant_report_path,\
        \ 'r') as f:\n        quant_report = json.load(f)\n\n# Count failures\nmodel_count\
        \ = count_failures(model_report)\nquant_count = count_failures(quant_report)\n\
        \nformatted_model = filter_and_format_report(model_report)\nformatted_quant\
        \ = filter_and_format_report(quant_report)\n\n# Write to files\nwith open('model_ci.txt',\
        \ 'w') as f:\n    if formatted_model:\n        if model_url:\n           \
        \ f.write(f\"\u274C **[{model_count} new failed tests from this PR]({model_url})**\
        \ \U0001F62D\\n\\n\")\n        else:\n            f.write(f\"\u274C **{model_count}\
        \ new failed tests from this PR** \U0001F62D\\n\\n\")\n        f.write(formatted_model)\n\
        \        f.write('\\n')\n\nwith open('quantization_ci.txt', 'w') as f:\n \
        \   if formatted_quant:\n        if quant_url:\n            f.write(f\"\u274C\
        \ **[{quant_count} new failed tests from this PR]({quant_url})** \U0001F62D\
        \\n\\n\")\n        else:\n            f.write(f\"\u274C **{quant_count} new\
        \ failed tests from this PR** \U0001F62D\\n\\n\")\n        f.write(formatted_quant)\n\
        \        f.write('\\n')\nPYTHON_SCRIPT\n"
    - name: Post results as PR comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
        pr_head_repo: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}
        run_commit: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_SHA }}
        pr_commit: ${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}
        main_commit: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_BASE_SHA }}
        model_ci_result: ${{ needs.model-ci.result }}
        quantization_ci_result: ${{ needs.quantization-ci.result }}
        model_infrastructure_ok: ${{ needs.model-ci.outputs.is_infrastructure_ok }}
        quant_infrastructure_ok: ${{ needs.quantization-ci.outputs.is_infrastructure_ok
          }}
      run: "# Create commit links (8 chars display, full SHA in URL)\nrun_commit_link=\"\
        [${run_commit:0:8}](https://github.com/${github_repository}/commit/${run_commit})\"\
        \npr_commit_link=\"[${pr_commit:0:8}](https://github.com/${pr_head_repo}/commit/${pr_commit})\"\
        \nmain_commit_link=\"[${main_commit:0:8}](https://github.com/${github_repository}/commit/${main_commit})\"\
        \n\n{\n  echo '## CI Results'\n  echo \"[Workflow Run \u2699\uFE0F]($GITHUB_RUN_URL)\"\
        \n  echo ''\n\n  echo '### Commit Info'\n  echo \"| Context | Commit | Description\
        \ |\"\n  echo \"|---------|--------|-------------|\"\n  echo \"| RUN | ${run_commit_link}\
        \ | workflow commit (merge commit) |\"\n  echo \"| PR | ${pr_commit_link}\
        \ | branch commit (from PR) |\"\n  echo \"| main | ${main_commit_link} | base\
        \ commit (on \\`main\\`) |\"\n  echo ''\n\n  # Check infrastructure health\
        \ - simple and clean!\n  infrastructure_error=false\n  \n  # Model CI\n  if\
        \ [[ \"$model_ci_result\" != \"skipped\" && \"$model_ci_result\" != \"cancelled\"\
        \ ]]; then\n    if [[ \"$model_infrastructure_ok\" == \"false\" ]]; then\n\
        \      echo \"\u26A0\uFE0F **Model CI failed to report results**\"\n     \
        \ echo ''\n      infrastructure_error=true\n    fi\n  fi\n  \n  # Quantization\
        \ CI\n  if [[ \"$quantization_ci_result\" != \"skipped\" && \"$quantization_ci_result\"\
        \ != \"cancelled\" ]]; then\n    if [[ \"$quant_infrastructure_ok\" == \"\
        false\" ]]; then\n      echo \"\u26A0\uFE0F **Quantization CI failed to report\
        \ results**\"\n      echo ''\n      infrastructure_error=true\n    fi\n  fi\n\
        \  \n  if [[ \"$infrastructure_error\" == \"true\" ]]; then\n    echo 'The\
        \ test failure analysis could not be completed. Please check the [workflow\
        \ run]('$GITHUB_RUN_URL') for details.'\n    echo \"STATUS=error\" >> $GITHUB_ENV\n\
        \n  # Check if both jobs were skipped or cancelled\n  elif [[ \"$model_ci_result\"\
        \ == \"skipped\" || \"$model_ci_result\" == \"cancelled\" ]] && \\\n     [[\
        \ \"$quantization_ci_result\" == \"skipped\" || \"$quantization_ci_result\"\
        \ == \"cancelled\" ]]; then\n    echo '\u26A0\uFE0F No test being reported\
        \ (jobs are skipped or cancelled)!'\n    echo \"STATUS=error\" >> $GITHUB_ENV\n\
        \n  # Check if either file has content\n  elif [ -s model_ci.txt ] || [ -s\
        \ quantization_ci.txt ]; then\n    echo \"STATUS=failure\" >> $GITHUB_ENV\n\
        \n    # Check if model_ci.txt has content\n    if [ -s model_ci.txt ]; then\n\
        \      echo '### Model CI Report'\n      echo ''\n      cat model_ci.txt\n\
        \      echo ''\n    fi\n    \n    # Check if quantization_ci.txt has content\n\
        \    if [ -s quantization_ci.txt ]; then\n      echo '### Quantization CI\
        \ Report'\n      echo ''\n      cat quantization_ci.txt\n      echo ''\n \
        \   fi\n  else\n    echo \"STATUS=success\" >> $GITHUB_ENV\n    echo '\u2705\
        \ No failing test specific to this PR \U0001F389 \U0001F44F !'\n  fi\n} >\
        \ comment_body.txt\n\ngh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/issues/${pr_number}/comments\"\
        \ \\\n  -F body=@comment_body.txt\n"
    - name: Update PR commit statuses
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_head_sha: ${{ needs.check-timestamps.outputs.PR_HEAD_SHA }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/statuses/${pr_head_sha}\"\
        \ \\\n  -f \"target_url=$GITHUB_RUN_URL\" -f \"state=$STATUS\" -f \"description=Slow\
        \ CI job\" -f \"context=pytest/custom-tests\"\n"
