name: PR comment GitHub CI
on:
  issue_comment:
    types:
    - created
    branches-ignore:
    - main
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}-${{ startsWith(github.event.comment.body,
    'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body,
    'run_slow') }}
  cancel-in-progress: true
permissions: read-all
env:
  HF_HOME: /mnt/cache
  TRANSFORMERS_IS_CI: yes
  OMP_NUM_THREADS: 8
  MKL_NUM_THREADS: 8
  RUN_SLOW: yes
  HF_HUB_READ_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}
  TF_FORCE_GPU_ALLOW_GROWTH: true
  CUDA_VISIBLE_DEVICES: 0,1
jobs:
  get-pr-number:
    name: Get PR number
    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('["ydshieh", "ArthurZucker",
      "zucchini-nlp", "molbap", "gante", "LysandreJik", "Cyrilvallez", "Rocketknight1",
      "SunMarc", "eustlb", "MekkCyber", "vasqu", "ivarflakstad", "stevhliu", "ebezzam",
      "remi-or", "itazap", "3outeille"]'), github.actor) && (startsWith(github.event.comment.body,
      'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body,
      'run_slow')) }}
    uses: ./.github/workflows/get-pr-number.yml
  get-pr-info:
    name: Get PR commit SHA
    needs: get-pr-number
    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}
    uses: ./.github/workflows/get-pr-info.yml
    with:
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
  check-timestamps:
    name: Check timestamps (security check)
    runs-on: ubuntu-latest
    needs: get-pr-info
    outputs:
      PR_HEAD_SHA: ${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}
      PR_MERGE_SHA: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_SHA }}
    steps:
    - name: Verify `merge_commit` timestamp is older than the issue comment timestamp
      env:
        COMMENT_DATE: ${{ github.event.comment.created_at }}
        PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP
          }}
      run: "COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\necho \"COMMENT_DATE:\
        \ $COMMENT_DATE\"\necho \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\nif [ $COMMENT_TIMESTAMP\
        \ -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n  echo \"Last commit on the pull\
        \ request is newer than the issue comment triggering this run! Abort!\";\n\
        \  exit -1;\nfi\n"
  get-tests:
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - check-timestamps
    outputs:
      models: ${{ steps.models_to_run.outputs.models }}
      quantizations: ${{ steps.models_to_run.outputs.quantizations }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
        ref: refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge
    - name: Verify merge commit SHA
      env:
        VERIFIED_PR_MERGE_SHA: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      run: "PR_MERGE_SHA=$(git log -1 --format=%H)\nif [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA\
        \ ]; then\n  echo \"The merged commit SHA is not the same as the verified\
        \ one! Security issue detected, abort the workflow!\";\n  exit -1;\nfi\n"
    - name: Get models to test
      env:
        PR_COMMENT: ${{ github.event.comment.body }}
      run: 'python -m pip install GitPython

        python utils/pr_slow_ci_models.py --message "$PR_COMMENT" | tee output.txt

        echo "models=$(tail -n 1 output.txt)" >> $GITHUB_ENV

        python utils/pr_slow_ci_models.py --message "$PR_COMMENT" --quantization |
        tee output2.txt

        echo "quantizations=$(tail -n 1 output2.txt)" >> $GITHUB_ENV

        '
    - name: Show models to test
      id: models_to_run
      run: 'echo "$models"

        echo "models=$models" >> $GITHUB_OUTPUT

        echo "$quantizations"

        echo "quantizations=$quantizations" >> $GITHUB_OUTPUT

        '
  report_error_earlier:
    name: Report error earlier
    if: ${{ always() && needs.get-pr-info.result == 'success' && needs.get-tests.result
      != 'success' }}
    needs:
    - get-pr-number
    - get-pr-info
    - get-tests
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Reply to the comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/issues/${pr_number}/comments\"\
        \ \\\n  -f body=\"\U0001F494 This comment contains \\`run-slow\\`, but unknown\
        \ error occurred and [the workflow run]($GITHUB_RUN_URL) aborted!\"\n"
  reply_to_comment:
    name: Reply to the comment
    if: ${{ needs.get-tests.outputs.models != '[]'  || needs.get-tests.outputs.quantizations
      != '[]' }}
    needs:
    - get-pr-number
    - get-tests
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Reply to the comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BODY: '\n\nmodels: ${{ needs.get-tests.outputs.models }}\nquantizations: ${{
          needs.get-tests.outputs.quantizations }}'
        github_repository: ${{ github.repository }}
        pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/issues/${pr_number}/comments\"\
        \ \\\n  -f body=\"This comment contains \\`run-slow\\`, running the specified\
        \ jobs: $(echo -e \"$BODY\")\"\n"
  create_run:
    name: Create run
    needs:
    - check-timestamps
    - reply_to_comment
    permissions:
      statuses: write
    runs-on: ubuntu-latest
    steps:
    - name: Create Run
      id: create_run
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_head_sha: ${{ needs.check-timestamps.outputs.PR_HEAD_SHA }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/statuses/${pr_head_sha}\"\
        \ \\\n  -f \"target_url=$GITHUB_RUN_URL\" -f \"state=pending\" -f \"description=Slow\
        \ CI job\" -f \"context=pytest/custom-tests\"\n"
  model-ci:
    name: Model CI
    if: ${{ needs.get-tests.outputs.models != '[]' }}
    uses: ./.github/workflows/self-scheduled.yml
    needs:
    - get-pr-number
    - check-timestamps
    - get-tests
    - create_run
    with:
      job: run_models_gpu
      slack_report_channel: '#transformers-ci-pr'
      docker: huggingface/transformers-all-latest-gpu
      ci_event: PR Comment CI
      report_repo_id: hf-internal-testing/transformers_pr_ci
      commit_sha: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      subdirs: ${{ needs.get-tests.outputs.models }}
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
    secrets: inherit
  quantization-ci:
    name: Quantization CI
    if: ${{ needs.get-tests.outputs.quantizations != '[]' }}
    uses: ./.github/workflows/self-scheduled.yml
    needs:
    - get-pr-number
    - check-timestamps
    - get-tests
    - create_run
    with:
      job: run_quantization_torch_gpu
      slack_report_channel: '#transformers-ci-pr'
      docker: huggingface/transformers-quantization-latest-gpu
      ci_event: PR Comment CI
      report_repo_id: hf-internal-testing/transformers_pr_ci
      commit_sha: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      subdirs: ${{ needs.get-tests.outputs.quantizations }}
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
    secrets: inherit
  report:
    name: Check & Report
    needs:
    - get-pr-number
    - check-timestamps
    - create_run
    - model-ci
    - quantization-ci
    permissions:
      pull-requests: write
      statuses: write
    if: ${{ always() && needs.create_run.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Show reports from jobs
      env:
        MODEL_REPORT: ${{ needs.model-ci.outputs.report }}
        QUANT_REPORT: ${{ needs.quantization-ci.outputs.report }}
      run: 'echo "$MODEL_REPORT"

        echo "$QUANT_REPORT"

        '
    - name: Process and filter reports
      env:
        MODEL_REPORT: ${{ needs.model-ci.outputs.report }}
        QUANT_REPORT: ${{ needs.quantization-ci.outputs.report }}
      run: "# Preprocess with Python\npython3 << 'PYTHON_SCRIPT'\nimport json\nimport\
        \ os\n\ndef filter_and_format_report(data):\n  \"\"\"\n  Filter out entries\
        \ where commit is `None` (failing tests who status is not certain) and format\
        \ as text\n  \"\"\"\n  lines = []\n  \n  for model, model_result in data.items():\n\
        \      model_lines = []\n      for device, failures in model_result.items():\n\
        \          \n          # Filter out None commits and extract just the test\
        \ names\n          test_names = [\n              failure['test'] \n      \
        \        for failure in failures \n              if isinstance(failure, dict)\
        \ and failure.get('commit') is not None\n          ]\n\n          # Add tests\
        \ to model lines\n          for idx, test_name in enumerate(test_names):\n\
        \              if idx == 0:\n                  job_link = failures[idx]['job_link']\n\
        \                  model_lines.append(f\"- [{model}]({job_link}):\")\n\n \
        \             model_lines.append(f\"    {test_name}\")\n\n      # Only add\
        \ model section if it has tests\n      if len(model_lines) > 0:\n        \
        \  lines.extend(model_lines)\n          lines.append(\"\")  # Empty line between\
        \ models\n  \n  return \"\\n\".join(lines).strip()\n\n# Load and filter reports\n\
        model_report_str = os.environ.get('MODEL_REPORT', '{}')\nquant_report_str\
        \ = os.environ.get('QUANT_REPORT', '{}')\n\nmodel_report = json.loads(model_report_str)\
        \ if model_report_str else {}\nquant_report = json.loads(quant_report_str)\
        \ if quant_report_str else {}\n\nformatted_model = filter_and_format_report(model_report)\n\
        formatted_quant = filter_and_format_report(quant_report)\n\n# Write to files\n\
        with open('model_ci.txt', 'w') as f:\n    f.write(formatted_model)\n    if\
        \ formatted_model:\n        f.write('\\n')\n\nwith open('quantization_ci.txt',\
        \ 'w') as f:\n    f.write(formatted_quant)\n    if formatted_quant:\n    \
        \    f.write('\\n')\nPYTHON_SCRIPT\n"
    - name: Post results as PR comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
        model_ci_result: ${{ needs.model-ci.result }}
        quantization_ci_result: ${{ needs.quantization-ci.result }}
      run: "{\n  echo '## CI Results'\n  echo \"[Workflow Run \u2699\uFE0F]($GITHUB_RUN_URL)\"\
        \n  echo ''\n\n  # Check if both jobs were skipped or cancelled\n  if [[ \"\
        $model_ci_result\" == \"skipped\" || \"$model_ci_result\" == \"cancelled\"\
        \ ]] && \\\n     [[ \"$quantization_ci_result\" == \"skipped\" || \"$quantization_ci_result\"\
        \ == \"cancelled\" ]]; then\n    echo '\u26A0\uFE0F No test being reported\
        \ (jobs are skipped or cancelled)!'\n    echo \"STATUS=error\" >> $GITHUB_ENV\n\
        \n  # Check if either file has content\n  elif [ -s model_ci.txt ] || [ -s\
        \ quantization_ci.txt ]; then\n    echo \"STATUS=failure\" >> $GITHUB_ENV\n\
        \n    # Check if model_ci.txt has content\n    if [ -s model_ci.txt ]; then\n\
        \      echo '### Model CI Report'\n      echo ''\n      echo '#### \u274C\
        \ Failed tests'\n      echo ''\n      cat model_ci.txt\n      echo ''\n  \
        \  fi\n    \n    # Check if quantization_ci.txt has content\n    if [ -s quantization_ci.txt\
        \ ]; then\n      echo '### Quantization CI Report'\n      echo ''\n      echo\
        \ '#### \u274C Failed tests'\n      echo ''\n      cat quantization_ci.txt\n\
        \      echo ''\n    fi\n  else\n    echo \"STATUS=success\" >> $GITHUB_ENV\n\
        \    echo '\u2705 No failing test specific to this PR \U0001F389 !'\n  fi\n\
        } > comment_body.txt\n\ngh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/issues/${pr_number}/comments\"\
        \ \\\n  -F body=@comment_body.txt\n"
    - name: Update PR commit statuses
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
        github_repository: ${{ github.repository }}
        pr_head_sha: ${{ needs.check-timestamps.outputs.PR_HEAD_SHA }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  \"repos/${github_repository}/statuses/${pr_head_sha}\"\
        \ \\\n  -f \"target_url=$GITHUB_RUN_URL\" -f \"state=$STATUS\" -f \"description=Slow\
        \ CI job\" -f \"context=pytest/custom-tests\"\n"
