name: PR comment GitHub CI
on:
  issue_comment:
    types:
    - created
    branches-ignore:
    - main
  pull_request: null
permissions: read-all
env:
  HF_HOME: /mnt/cache
  TRANSFORMERS_IS_CI: yes
  OMP_NUM_THREADS: 8
  MKL_NUM_THREADS: 8
  RUN_SLOW: yes
  HF_HUB_READ_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}
  TF_FORCE_GPU_ALLOW_GROWTH: true
  CUDA_VISIBLE_DEVICES: 0,1
jobs:
  get-pr-number:
    name: Get PR number
    uses: ./.github/workflows/get-pr-number.yml
  get-pr-info:
    name: Get PR commit SHA
    needs: get-pr-number
    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}
    uses: ./.github/workflows/get-pr-info.yml
    with:
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
  check-timestamps:
    name: Check timestamps (security check)
    runs-on: ubuntu-latest
    needs: get-pr-info
    outputs:
      PR_HEAD_SHA: ${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}
      PR_MERGE_SHA: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_SHA }}
    steps:
    - name: Verify `merge_commit` timestamp is older than the issue comment timestamp
      env:
        COMMENT_DATE: ${{ github.event.comment.created_at }}
        PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP
          }}
      run: 'echo "good"

        '
  get-tests:
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - check-timestamps
    outputs:
      models: ${{ steps.models_to_run.outputs.models }}
      quantizations: ${{ steps.models_to_run.outputs.quantizations }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
        ref: refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge
    - name: Get models to test
      env:
        PR_COMMENT: 'run-slow: audioflamingo3, vit'
      run: 'python -m pip install GitPython

        python utils/pr_slow_ci_models.py --message "$PR_COMMENT" | tee output.txt

        echo ''models=$(tail -n 1 output.txt)'' >> $GITHUB_ENV

        python utils/pr_slow_ci_models.py --message "$PR_COMMENT" --quantization |
        tee output2.txt

        echo ''quantizations=$(tail -n 1 output2.txt)'' >> $GITHUB_ENV

        '
    - name: Show models to test
      id: models_to_run
      run: 'echo "${{ env.models }}"

        echo "models=${{ env.models }}" >> $GITHUB_OUTPUT

        echo "${{ env.quantizations }}"

        echo "quantizations=${{ env.quantizations }}" >> $GITHUB_OUTPUT

        '
  report_error_earlier:
    name: Report error earlier
    if: ${{ always() && needs.get-pr-info.result == 'success' && needs.get-tests.result
      != 'success' }}
    needs:
    - get-pr-number
    - get-pr-info
    - get-tests
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Reply to the comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  repos/${{ github.repository\
        \ }}/issues/${{ needs.get-pr-number.outputs.PR_NUMBER }}/comments \\\n  -f\
        \ body=\"\U0001F494 This comment contains \\`run-slow\\`, but unknown error\
        \ occurred and [the workflow run]($GITHUB_RUN_URL) aborted!\"\n"
  reply_to_comment:
    name: Reply to the comment
    if: ${{ needs.get-tests.outputs.models != '[]'  || needs.get-tests.outputs.quantizations
      != '[]' }}
    needs:
    - get-pr-number
    - get-tests
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Reply to the comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BODY: '\n\nmodels: ${{ needs.get-tests.outputs.models }}\nquantizations: ${{
          needs.get-tests.outputs.quantizations }}'
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  repos/${{ github.repository\
        \ }}/issues/${{ needs.get-pr-number.outputs.PR_NUMBER }}/comments \\\n  -f\
        \ body=\"This comment contains \\`run-slow\\`, running the specified jobs:\
        \ $(echo -e '${{ env.BODY }}')\"\n"
  create_run:
    name: Create run
    needs:
    - check-timestamps
    - reply_to_comment
    permissions:
      statuses: write
    runs-on: ubuntu-latest
    steps:
    - name: Create Run
      id: create_run
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  repos/${{ github.repository\
        \ }}/statuses/${{ needs.check-timestamps.outputs.PR_HEAD_SHA }} \\\n  -f \"\
        target_url=$GITHUB_RUN_URL\" -f \"state=pending\" -f \"description=Slow CI\
        \ job\" -f \"context=pytest/custom-tests\"\n"
  model-ci:
    name: Model CI
    if: ${{ needs.get-tests.outputs.models != '[]' }}
    uses: ./.github/workflows/self-scheduled.yml
    needs:
    - get-pr-number
    - check-timestamps
    - get-tests
    - create_run
    with:
      job: run_models_gpu
      slack_report_channel: '#transformers-ci-pr'
      docker: huggingface/transformers-all-latest-gpu
      ci_event: PR Comment CI
      report_repo_id: hf-internal-testing/transformers_pr_ci
      commit_sha: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      subdirs: ${{ needs.get-tests.outputs.models }}
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
    secrets: inherit
  quantization-ci:
    name: Quantization CI
    if: ${{ needs.get-tests.outputs.quantizations != '[]' }}
    uses: ./.github/workflows/self-scheduled.yml
    needs:
    - get-pr-number
    - check-timestamps
    - get-tests
    - create_run
    with:
      job: run_quantization_torch_gpu
      slack_report_channel: '#transformers-ci-pr'
      docker: huggingface/transformers-quantization-latest-gpu
      ci_event: PR Comment CI
      report_repo_id: hf-internal-testing/transformers_pr_ci
      commit_sha: ${{ needs.check-timestamps.outputs.PR_MERGE_SHA }}
      subdirs: ${{ needs.get-tests.outputs.quantizations }}
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
    secrets: inherit
  check_report:
    name: Check report
    needs:
    - get-pr-number
    - check-timestamps
    - create_run
    - model-ci
    - quantization-ci
    if: ${{ always() && needs.create_run.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Check report
      run: 'echo "${{ needs.model-ci.result }}"

        echo "${{ needs.model-ci.outputs.report }}"

        '
  report:
    name: Check & Report
    needs:
    - get-pr-number
    - check-timestamps
    - create_run
    - model-ci
    - quantization-ci
    permissions:
      pull-requests: write
      statuses: write
    if: ${{ always() && needs.create_run.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Show reports from jobs
      run: 'echo "${{ needs.model-ci.outputs.report }}"

        echo "${{ needs.quantization-ci.outputs.report }}"

        '
    - name: Process and filter reports
      env:
        MODEL_REPORT: ${{ needs.model-ci.outputs.report }}
        QUANT_REPORT: ${{ needs.quantization-ci.outputs.report }}
      run: "# Preprocess with Python\npython3 << 'PYTHON_SCRIPT'\nimport json\nimport\
        \ os\n\ndef filter_and_format_report(data):\n  \"\"\"\n  Filter out entries\
        \ where commit is `None` (failing tests who status is not certain) and format\
        \ as text\n  \"\"\"\n  lines = []\n  \n  for model, model_result in data.items():\n\
        \      model_lines = []\n      for device, failures in model_result.items():\n\
        \          \n          # Filter out None commits and extract just the test\
        \ names\n          test_names = [\n              failure['test'] \n      \
        \        for failure in failures \n              if isinstance(failure, dict)\
        \ and failure.get('commit') is not None\n          ]\n\n          # Add tests\
        \ to model lines\n          for idx, test_name in enumerate(test_names):\n\
        \              if idx == 0:\n                  job_link = failures[idx]['job_link']\n\
        \                  model_lines.append(f\"- [{model}]({job_link}):\")\n\n \
        \             model_lines.append(f\"    {test_name}\")\n\n      # Only add\
        \ model section if it has tests\n      if len(model_lines) > 0:\n        \
        \  lines.extend(model_lines)\n          lines.append(\"\")  # Empty line between\
        \ models\n  \n  return \"\\n\".join(lines).strip()\n\n# Load and filter reports\n\
        model_report_str = os.environ.get('MODEL_REPORT', '{}')\nquant_report_str\
        \ = os.environ.get('QUANT_REPORT', '{}')\n\nmodel_report = json.loads(model_report_str)\
        \ if model_report_str else {}\nquant_report = json.loads(quant_report_str)\
        \ if quant_report_str else {}\n\nformatted_model = filter_and_format_report(model_report)\n\
        formatted_quant = filter_and_format_report(quant_report)\n\n# Write to files\n\
        with open('model_ci.txt', 'w') as f:\n    f.write(formatted_model)\n    if\
        \ formatted_model:\n        f.write('\\n')\n\nwith open('quantization_ci.txt',\
        \ 'w') as f:\n    f.write(formatted_quant)\n    if formatted_quant:\n    \
        \    f.write('\\n')\nPYTHON_SCRIPT\n"
    - name: Post results as PR comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
      run: "{\n  echo '## CI Results'\n  echo \"[Workflow Run \u2699\uFE0F]($GITHUB_RUN_URL)\"\
        \n  echo ''\n\n  # Check if both jobs were skipped or cancelled\n  if [[ \"\
        ${{ needs.model-ci.result }}\" == \"skipped\" || \"${{ needs.model-ci.result\
        \ }}\" == \"cancelled\" ]] && \\\n     [[ \"${{ needs.quantization-ci.result\
        \ }}\" == \"skipped\" || \"${{ needs.quantization-ci.result }}\" == \"cancelled\"\
        \ ]]; then\n    echo '\u26A0\uFE0F No test being reported (jobs are skipped\
        \ or cancelled)!'\n    echo \"STATUS=error\" >> $GITHUB_ENV\n\n  # Check if\
        \ either file has content\n  elif [ -s model_ci.txt ] || [ -s quantization_ci.txt\
        \ ]; then\n    echo \"STATUS=failure\" >> $GITHUB_ENV\n\n    # Check if model_ci.txt\
        \ has content\n    if [ -s model_ci.txt ]; then\n      echo '### Model CI\
        \ Report'\n      echo ''\n      echo '#### \u274C Failed tests'\n      echo\
        \ ''\n      cat model_ci.txt\n      echo ''\n    fi\n    \n    # Check if\
        \ quantization_ci.txt has content\n    if [ -s quantization_ci.txt ]; then\n\
        \      echo '### Quantization CI Report'\n      echo ''\n      echo '####\
        \ \u274C Failed tests'\n      echo ''\n      cat quantization_ci.txt\n   \
        \   echo ''\n    fi\n  else\n    echo \"STATUS=success\" >> $GITHUB_ENV\n\
        \    echo '\u2705 No failing test specific to this PR \U0001F389 !'\n  fi\n\
        } > comment_body.txt\n\ngh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  repos/${{ github.repository\
        \ }}/issues/${{ needs.get-pr-number.outputs.PR_NUMBER }}/comments \\\n  -F\
        \ body=@comment_body.txt\n"
    - name: Update PR commit statuses
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{
          github.run_id }}
      run: "gh api \\\n  --method POST \\\n  -H \"Accept: application/vnd.github+json\"\
        \ \\\n  -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n  repos/${{ github.repository\
        \ }}/statuses/${{ needs.check-timestamps.outputs.PR_HEAD_SHA }} \\\n  -f \"\
        target_url=$GITHUB_RUN_URL\" -f \"state=${{ env.STATUS }}\" -f \"description=Slow\
        \ CI job\" -f \"context=pytest/custom-tests\"\n"
