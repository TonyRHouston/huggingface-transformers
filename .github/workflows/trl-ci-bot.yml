name: TRL CI bot
on:
  workflow_dispatch: {}
permissions:
  contents: read
  pull-requests: read
  issues: read
jobs:
  dispatch:
    if: 'github.event.issue.pull_request && contains(github.event.comment.body, ''/trl-ci'')

      '
    runs-on: ubuntu-latest
    steps:
    - name: Gate on trusted commenter
      id: trust
      run: "assoc=\"${{ github.event.comment.author_association }}\"\ncase \"$assoc\"\
        \ in\n  MEMBER|OWNER|COLLABORATOR) echo \"trusted=true\" >> $GITHUB_OUTPUT\
        \ ;;\n  *) echo \"trusted=false\" >> $GITHUB_OUTPUT ;;\nesac\n"
    - name: Ignore untrusted commenter
      if: steps.trust.outputs.trusted != 'true'
      run: 'echo "Untrusted commenter; ignoring."

        exit 0

        '
    - name: Fetch PR head SHA + number
      id: pr
      env:
        GH_TOKEN: ${{ github.token }}
      run: 'PR_URL="${{ github.event.issue.pull_request.url }}"

        sha=$(gh api "$PR_URL" --jq .head.sha)

        number=$(gh api "$PR_URL" --jq .number)

        echo "sha=$sha" >> $GITHUB_OUTPUT

        echo "number=$number" >> $GITHUB_OUTPUT

        '
    - name: Dispatch TRL workflow
      id: dispatch
      env:
        GH_TOKEN: ${{ secrets.TRL_CI_DISPATCH_TOKEN }}
      run: "gh workflow run \"Tests against Transformers branch\" \\\n  -R huggingface/trl\
        \ \\\n  -f transformers_ref=${{ steps.pr.outputs.sha }}\n"
    - name: Find TRL workflow run URL
      id: find_run
      env:
        GH_TOKEN: ${{ secrets.TRL_CI_DISPATCH_TOKEN }}
      run: "echo \"Waiting for workflow to appear...\"\nfor i in {1..10}; do\n  run_url=$(gh\
        \ api \\\n    repos/huggingface/trl/actions/workflows \\\n    --jq '.workflows[]\
        \ | select(.name==\"Tests against Transformers branch\") | .id')\n\n  if [\
        \ -n \"$run_url\" ]; then\n    run=$(gh api \\\n      repos/huggingface/trl/actions/workflows/$run_url/runs\
        \ \\\n      -f event=workflow_dispatch \\\n      -f per_page=5 \\\n      --jq\
        \ '.workflow_runs[0].html_url')\n    if [ -n \"$run\" ]; then\n      echo\
        \ \"url=$run\" >> $GITHUB_OUTPUT\n      break\n    fi\n  fi\n  sleep 5\ndone\n"
    - name: Comment back on PR with link
      env:
        GH_TOKEN: ${{ github.token }}
      run: "gh api -X POST \\\n  /repos/${{ github.repository }}/issues/${{ github.event.issue.number\
        \ }}/comments \\\n  -f body=\"\U0001F680 **TRL CI triggered** against transformers\
        \ commit \\`${{ steps.pr.outputs.sha }}\\`\\n\\n\U0001F517 **Run:** ${{ steps.find_run.outputs.url\
        \ }}\"\n"
