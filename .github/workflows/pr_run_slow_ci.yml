name: PR slow CI
on:
  pull_request_target:
    types:
    - opened
    - synchronize
    - reopened
jobs:
  get-pr-number:
    name: Get PR number
    uses: ./.github/workflows/get-pr-number.yml
  get-pr-info:
    name: Get PR commit SHA
    needs: get-pr-number
    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}
    uses: ./.github/workflows/get-pr-info.yml
    with:
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
  verity_pr_commit:
    name: Verity PR commit corresponds to a specific event by comparing timestamps
    if: ${{ github.event.comment.created_at != '' }}
    runs-on: ubuntu-latest
    needs: get-pr-info
    env:
      COMMENT_DATE: ${{ github.event.comment.created_at }}
      PR_MERGE_COMMIT_DATE: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_DATE }}
      PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP
        }}
    steps:
    - run: "COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\necho \"COMMENT_DATE:\
        \ $COMMENT_DATE\"\necho \"PR_MERGE_COMMIT_DATE: $PR_MERGE_COMMIT_DATE\"\n\
        echo \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\necho \"PR_MERGE_COMMIT_TIMESTAMP:\
        \ $PR_MERGE_COMMIT_TIMESTAMP\"\nif [ $COMMENT_TIMESTAMP -le $PR_MERGE_COMMIT_TIMESTAMP\
        \ ]; then\n  echo \"Last commit on the pull request is newer than the issue\
        \ comment triggering this run! Abort!\";\n  exit -1;\nfi\n"
  get-jobs:
    name: Get test files to run
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - get-pr-info
    outputs:
      jobs: ${{ steps.get_jobs.outputs.jobs_to_run }}
    steps:
    - name: Get repository content
      id: repo_content
      uses: actions/github-script@v6
      with:
        script: "const { data: tests_dir } = await github.rest.repos.getContent({\n\
          \  owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n  repo:\
          \ '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n  path: 'tests',\n\
          \  ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n});\n\nconst {\
          \ data: tests_models_dir } = await github.rest.repos.getContent({\n  owner:\
          \ '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n  repo: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME\
          \ }}',\n  path: 'tests/models',\n  ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA\
          \ }}',\n});\n\nconst { data: tests_quantization_dir } = await github.rest.repos.getContent({\n\
          \  owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n  repo:\
          \ '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n  path: 'tests/quantization',\n\
          \  ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n});\n\ncore.setOutput('tests_dir',\
          \ tests_dir);\ncore.setOutput('tests_models_dir', tests_models_dir);\ncore.setOutput('tests_quantization_dir',\
          \ tests_quantization_dir);\n"
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: Write pr_files file
      run: 'cat > pr_files.txt << ''EOF''

        ${{ needs.get-pr-info.outputs.PR_FILES }}

        EOF

        '
    - name: Write tests_dir file
      run: 'cat > tests_dir.txt << ''EOF''

        ${{ steps.repo_content.outputs.tests_dir }}

        EOF

        '
    - name: Write tests_models_dir file
      run: 'cat > tests_models_dir.txt << ''EOF''

        ${{ steps.repo_content.outputs.tests_models_dir }}

        EOF

        '
    - name: Write tests_quantization_dir file
      run: 'cat > tests_quantization_dir.txt << ''EOF''

        ${{ steps.repo_content.outputs.tests_quantization_dir }}

        EOF

        '
    - name: Run script to get jobs to run
      id: get_jobs
      run: 'python utils/get_pr_run_slow_jobs.py | tee output.txt

        echo "jobs_to_run: $(tail -n 1 output.txt)"

        echo "jobs_to_run=$(tail -n 1 output.txt)" >> $GITHUB_OUTPUT

        '
  send_comment:
    name: Send a comment to suggest jobs to run
    if: ${{ needs.get-jobs.outputs.jobs != '' }}
    needs:
    - get-pr-number
    - get-jobs
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Delete existing comment and send new one
      uses: actions/github-script@v7
      env:
        BODY: '


          run-slow: ${{ needs.get-jobs.outputs.jobs }}'
      with:
        script: "const prNumber = ${{ needs.get-pr-number.outputs.PR_NUMBER }};\n\
          const commentPrefix = \"**[For maintainers]** Suggested jobs to run (before\
          \ merge)\";\n\n// Get all comments on the PR\nconst { data: comments } =\
          \ await github.rest.issues.listComments({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  issue_number: prNumber\n});\n\n// Find existing\
          \ comment(s) that start with our prefix\nconst existingComments = comments.filter(comment\
          \ => \n  comment.user.login === 'github-actions[bot]' && \n  comment.body.startsWith(commentPrefix)\n\
          );\n\n// Delete existing comment(s)\nfor (const comment of existingComments)\
          \ {\n  console.log(`Deleting existing comment #${comment.id}`);\n  await\
          \ github.rest.issues.deleteComment({\n    owner: context.repo.owner,\n \
          \   repo: context.repo.repo,\n    comment_id: comment.id\n  });\n}\n\n//\
          \ Create new comment\nconst newBody = `${commentPrefix}${process.env.BODY}`;\n\
          await github.rest.issues.createComment({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  issue_number: prNumber,\n  body: newBody\n\
          });\n\nconsole.log('\u2705 Comment updated successfully');"
