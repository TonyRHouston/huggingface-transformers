name: PR slow CI
on:
  pull_request_target:
    types:
    - opened
    - synchronize
    - reopened
jobs:
  get-pr-number:
    name: Get PR number
    uses: ./.github/workflows/get-pr-number.yml
  get-pr-info:
    name: Get PR commit SHA
    needs: get-pr-number
    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}
    uses: ./.github/workflows/get-pr-info.yml
    with:
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
  get-jobs:
    name: Get test files to run
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - get-pr-info
    outputs:
      jobs: ${{ steps.get_jobs.outputs.jobs_to_run }}
    steps:
    - name: Get repository content
      id: repo_content
      uses: actions/github-script@v6
      with:
        script: "const { data: tests_dir } = await github.rest.repos.getContent({\n\
          \  owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n  repo:\
          \ '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n  path: 'tests',\n\
          \  ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n});\n\nconst {\
          \ data: tests_models_dir } = await github.rest.repos.getContent({\n  owner:\
          \ '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n  repo: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME\
          \ }}',\n  path: 'tests/models',\n  ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA\
          \ }}',\n});\n\nconst { data: tests_quantization_dir } = await github.rest.repos.getContent({\n\
          \  owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n  repo:\
          \ '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n  path: 'tests/quantization',\n\
          \  ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n});\n\ncore.setOutput('tests_dir',\
          \ tests_dir);\ncore.setOutput('tests_models_dir', tests_models_dir);\ncore.setOutput('tests_quantization_dir',\
          \ tests_quantization_dir);\n"
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: Write pr_files file
      run: 'cat > pr_files.txt << ''EOF''

        ${{ needs.get-pr-info.outputs.PR_FILES }}

        EOF

        '
    - name: Write tests_dir file
      run: 'cat > tests_dir.txt << ''EOF''

        ${{ steps.repo_content.outputs.tests_dir }}

        EOF

        '
    - name: Write tests_models_dir file
      run: 'cat > tests_models_dir.txt << ''EOF''

        ${{ steps.repo_content.outputs.tests_models_dir }}

        EOF

        '
    - name: Write tests_quantization_dir file
      run: 'cat > tests_quantization_dir.txt << ''EOF''

        ${{ steps.repo_content.outputs.tests_quantization_dir }}

        EOF

        '
    - name: Run script to get jobs to run
      id: get_jobs
      run: 'python utils/get_pr_run_slow_jobs.py | tee output.txt

        echo "jobs_to_run: $(tail -n 1 output.txt)"

        echo "jobs_to_run=$(tail -n 1 output.txt)" >> $GITHUB_OUTPUT

        '
  send_comment:
    name: Send a comment to suggest jobs to run
    if: ${{ needs.get-jobs.outputs.jobs != '' }}
    needs:
    - get-pr-number
    - get-jobs
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Check and update comment if needed
      uses: actions/github-script@v7
      env:
        BODY: '


          run-slow: ${{ needs.get-jobs.outputs.jobs }}'
      with:
        script: "const prNumber = ${{ needs.get-pr-number.outputs.PR_NUMBER }};\n\
          const commentPrefix = \"**[For maintainers]** Suggested jobs to run (before\
          \ merge)\";\nconst thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000);\
          \ // 30 minutes ago\nconst newBody = `${commentPrefix}${process.env.BODY}`;\n\
          \n// Get all comments on the PR\nconst { data: comments } = await github.rest.issues.listComments({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number:\
          \ prNumber\n});\n\n// Find existing comments that start with our prefix\n\
          const existingComments = comments.filter(comment => \n  comment.user.login\
          \ === 'github-actions[bot]' && \n  comment.body.startsWith(commentPrefix)\n\
          );\n\nlet shouldCreateNewComment = true;\nlet commentsToDelete = [];\n\n\
          if (existingComments.length > 0) {\n  // Get the most recent comment\n \
          \ const mostRecentComment = existingComments\n    .sort((a, b) => new Date(b.created_at)\
          \ - new Date(a.created_at))[0];\n  \n  const commentDate = new Date(mostRecentComment.created_at);\n\
          \  const isOld = commentDate < thirtyMinutesAgo;\n  const isDifferentContent\
          \ = mostRecentComment.body !== newBody;\n  \n  console.log(`Most recent\
          \ comment created: ${mostRecentComment.created_at}`);\n  console.log(`Is\
          \ older than 30 minutes: ${isOld}`);\n  console.log(`Has different content:\
          \ ${isDifferentContent}`);\n  \n  if (isOld || isDifferentContent) {\n \
          \   // Delete all existing comments and create new one\n    commentsToDelete\
          \ = existingComments;\n    console.log(`Will delete ${commentsToDelete.length}\
          \ existing comment(s) and create new one`);\n  } else {\n    // Content\
          \ is same and comment is recent, skip\n    shouldCreateNewComment = false;\n\
          \    console.log('Comment is recent and content unchanged, skipping update');\n\
          \  }\n} else {\n  console.log('No existing comments found, will create new\
          \ one');\n}\n\n// Delete old comments if needed\nfor (const comment of commentsToDelete)\
          \ {\n  console.log(`Deleting comment #${comment.id} (created: ${comment.created_at})`);\n\
          \  await github.rest.issues.deleteComment({\n    owner: context.repo.owner,\n\
          \    repo: context.repo.repo,\n    comment_id: comment.id\n  });\n}\n\n\
          // Create new comment if needed\nif (shouldCreateNewComment) {\n  await\
          \ github.rest.issues.createComment({\n    owner: context.repo.owner,\n \
          \   repo: context.repo.repo,\n    issue_number: prNumber,\n    body: newBody\n\
          \  });\n  console.log('\u2705 New comment created');\n} else {\n  console.log('\u2139\
          \uFE0F No comment update needed');\n}"
