name: Self-hosted runner (scheduled)
on:
  workflow_call:
    inputs:
      job:
        required: true
        type: string
      slack_report_channel:
        required: true
        type: string
env:
  HF_HOME: /mnt/cache
  TRANSFORMERS_IS_CI: yes
  OMP_NUM_THREADS: 8
  MKL_NUM_THREADS: 8
  RUN_SLOW: yes
  HF_HUB_READ_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}
  SIGOPT_API_TOKEN: ${{ secrets.SIGOPT_API_TOKEN }}
  TF_FORCE_GPU_ALLOW_GROWTH: true
  RUN_PT_TF_CROSS_TESTS: 1
  CUDA_VISIBLE_DEVICES: 0,1
  NUM_SLICES: 2
jobs:
  run_all_tests_torch_cuda_extensions_gpu:
    if: ${{ inputs.job == 'run_all_tests_torch_cuda_extensions_gpu' }}
    name: Torch CUDA extension tests
    strategy:
      fail-fast: false
      matrix:
        machine_type:
        - multi-gpu
    runs-on: ubuntu-latest
    container:
      image: huggingface/transformers-pytorch-deepspeed-latest-gpu
      options: --gpus all --shm-size "16gb" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/
    steps:
    - name: Update clone
      working-directory: /workspace/transformers
      run: git fetch && git checkout ${{ github.sha }}
    - name: Reinstall transformers in edit mode (remove the one installed during docker
        image build)
      working-directory: /workspace/transformers
      run: python3 -m pip uninstall -y transformers && python3 -m pip install -e .
    - name: Remove cached torch extensions
      run: rm -rf /github/home/.cache/torch_extensions/
    - name: Pre build DeepSpeed *again*
      working-directory: /workspace
      run: 'python3 -m pip uninstall -y deepspeed

        DS_DISABLE_NINJA=1 DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip
        install deepspeed --global-option="build_ext" --global-option="-j8" --no-cache
        -v --disable-pip-version-check

        '
    - name: NVIDIA-SMI
      run: 'nvidia-smi

        '
    - name: Environment
      working-directory: /workspace/transformers
      run: 'python utils/print_env.py

        '
    - name: Show installed libraries and their versions
      working-directory: /workspace/transformers
      run: pip freeze
    - name: Run all tests on GPU
      working-directory: /workspace/transformers
      run: 'python3 -m pytest -v tests/deepspeed/test_deepspeed.py

        '
