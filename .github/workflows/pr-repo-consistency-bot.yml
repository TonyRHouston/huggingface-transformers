name: PR Repo. Consistency Bot
on:
  issue_comment:
    types:
    - created
    branches-ignore:
    - main
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}-${{ startsWith(github.event.comment.body,
    '@bot /repo') }}
  cancel-in-progress: true
permissions: read-all
jobs:
  get-pr-number:
    name: Get PR number
    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('["ydshieh", "ArthurZucker",
      "zucchini-nlp", "molbap", "gante", "LysandreJik", "Cyrilvallez", "Rocketknight1",
      "SunMarc", "eustlb", "MekkCyber", "vasqu", "ivarflakstad", "stevhliu", "ebezzam",
      "remi-or", "itazap", "3outeille"]'), github.actor) && startsWith(github.event.comment.body,
      '@bot /repo') }}
    uses: ./.github/workflows/get-pr-number.yml
  get-pr-info:
    name: Get PR commit SHA
    needs: get-pr-number
    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}
    uses: ./.github/workflows/get-pr-info.yml
    with:
      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
  check-timestamps:
    name: Check timestamps (security check)
    runs-on: ubuntu-latest
    needs: get-pr-info
    outputs:
      VERIFIED_PR_HEAD_SHA: ${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}
    steps:
    - name: Verify `merge_commit` timestamp is older than the issue comment timestamp
      env:
        COMMENT_DATE: ${{ github.event.comment.created_at }}
        PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP
          }}
      run: "COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\necho \"COMMENT_DATE:\
        \ $COMMENT_DATE\"\necho \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\nif [ $COMMENT_TIMESTAMP\
        \ -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n  echo \"Last commit on the pull\
        \ request is newer than the issue comment triggering this run! Abort!\";\n\
        \  exit -1;\nfi\n"
  init_comment_with_url:
    name: Init Comment on PR
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - check-timestamps
    outputs:
      comment_id: ${{ steps.init_comment.outputs.comment_id }}
    permissions:
      pull-requests: write
    steps:
    - name: Delete existing bot comment if it exists
      env:
        PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      uses: actions/github-script@v6
      with:
        script: "const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\n\n// Get\
          \ all comments on the PR\nconst { data: comments } = await github.rest.issues.listComments({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number:\
          \ PR_NUMBER\n});\n\n// Find existing bot comments that start with \"Repo.\
          \ Consistency\"\nconst existingComments = comments.filter(comment => \n\
          \  comment.user.login === 'github-actions[bot]' && \n  comment.body.startsWith('Repo.\
          \ Consistency')\n);\n\nif (existingComments.length > 0) {\n  // Get the\
          \ most recent comment\n  const mostRecentComment = existingComments\n  \
          \  .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];\n\
          \  \n  console.log(`Deleting most recent comment #${mostRecentComment.id}`);\n\
          \  await github.rest.issues.deleteComment({\n    owner: context.repo.owner,\n\
          \    repo: context.repo.repo,\n    comment_id: mostRecentComment.id\n  });\n\
          }\n"
    - name: Comment on PR with workflow run link
      id: init_comment
      env:
        PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      uses: actions/github-script@v6
      with:
        script: "const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\nconst runUrl\
          \ = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`\n\
          \nconst { data: botComment } = await github.rest.issues.createComment({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number:\
          \ PR_NUMBER,\n  body: `Repo. Consistency fix is beginning .... [View the\
          \ workflow run here](${runUrl}).`\n});\ncore.setOutput('comment_id', botComment.id);\n"
  run-repo-consistency-checks:
    runs-on: ubuntu-latest
    needs:
    - get-pr-info
    - check-timestamps
    - init_comment_with_url
    outputs:
      changes_detected: ${{ steps.run_checks.outputs.changes_detected }}
    steps:
    - name: Checkout base repository
      uses: actions/checkout@v4
      with:
        ref: main
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install dependencies from trusted main branch
      run: 'python -m pip install --upgrade pip

        pip install -e ".[quality]"

        pip install --no-cache-dir --upgrade ''torch'' ''torchaudio'' ''torchvision''
        --index-url https://download.pytorch.org/whl/cpu

        '
    - name: Fetch and checkout PR code manually
      env:
        PR_HEAD_REPO_FULL_NAME: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME
          }}
        PR_HEAD_SHA: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}
      run: '# Create separate directory for PR code

        mkdir -p pr-repo

        cd pr-repo


        # Initialize git and fetch only the specific commit

        git init

        git remote add pr-origin https://github.com/${PR_HEAD_REPO_FULL_NAME}.git

        git fetch --depth=1 pr-origin ${PR_HEAD_SHA}

        git checkout ${PR_HEAD_SHA}

        '
    - name: Run checks with trusted script
      id: run_checks
      run: "# Copy trusted script to PR directory\ncp utils/check_copies.py pr-repo/utils/check_copies.py\n\
        \n# Run the trusted script in PR directory\ncd pr-repo\npython utils/check_copies.py\
        \ --fix_and_overwrite\n\n# Check if there are changes\nif [ -n \"$(git status\
        \ --porcelain)\" ]; then\n  echo \"changes_detected=true\" >> $GITHUB_OUTPUT\n\
        else\n  echo \"changes_detected=false\" >> $GITHUB_OUTPUT\nfi\n"
    - name: Save modified files
      if: steps.run_checks.outputs.changes_detected == 'true'
      run: "cd pr-repo\nmkdir -p ../artifact-staging\ngit diff --name-only > ../artifact-staging/modified-files.txt\n\
        # Copy each modified file\nwhile IFS= read -r file; do\n  mkdir -p \"../artifact-staging/pr-repo/$(dirname\
        \ \"$file\")\"\n  cp \"$file\" \"../artifact-staging/pr-repo/$file\"\ndone\
        \ < ../artifact-staging/modified-files.txt\n"
    - name: Upload modified files
      if: steps.run_checks.outputs.changes_detected == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: modified-files
        path: artifact-staging/
  commit-and-comment:
    runs-on: ubuntu-latest
    needs:
    - get-pr-number
    - get-pr-info
    - check-timestamps
    - init_comment_with_url
    - run-repo-consistency-checks
    if: always()
    permissions:
      pull-requests: write
    steps:
    - name: Download modified files
      if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'
      uses: actions/download-artifact@v4
      with:
        name: modified-files
    - name: Push changes via GitHub API (no checkout)
      if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'
      uses: actions/github-script@v6
      env:
        PR_HEAD_REF: ${{ needs.get-pr-info.outputs.PR_HEAD_REF }}
        PR_HEAD_SHA: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}
        PR_HEAD_REPO_OWNER: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}
        PR_HEAD_REPO_NAME: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}
      with:
        github-token: ${{ secrets.HF_STYLE_BOT_ACTION }}
        script: "const fs = require('fs');\nconst path = require('path');\n\nconst\
          \ owner = process.env.PR_HEAD_REPO_OWNER;\nconst repo = process.env.PR_HEAD_REPO_NAME;\n\
          const baseSha = process.env.PR_HEAD_SHA;\nconst branch = process.env.PR_HEAD_REF;\n\
          \nconsole.log(`Creating commit on ${owner}/${repo} branch ${branch} from\
          \ ${baseSha}`);\n\n// Read list of modified files\nconst modifiedFiles =\
          \ fs.readFileSync('modified-files.txt', 'utf8')\n  .trim()\n  .split('\\\
          n')\n  .filter(f => f.length > 0);\n\nconsole.log(`Modified files: ${modifiedFiles.join(',\
          \ ')}`);\n\n// Get the base commit to retrieve its tree SHA (metadata only,\
          \ no checkout)\nconst { data: baseCommit } = await github.rest.git.getCommit({\n\
          \  owner,\n  repo,\n  commit_sha: baseSha\n});\n\nconsole.log(`Base tree\
          \ SHA: ${baseCommit.tree.sha}`);\n\n// Create blobs for each modified file\n\
          const tree = [];\nfor (const file of modifiedFiles) {\n  const filePath\
          \ = path.join('pr-repo', file);\n  const content = fs.readFileSync(filePath,\
          \ 'utf8');\n  \n  console.log(`Creating blob for ${file}`);\n  const { data:\
          \ blob } = await github.rest.git.createBlob({\n    owner,\n    repo,\n \
          \   content: content,\n    encoding: 'utf-8'\n  });\n  \n  tree.push({\n\
          \    path: file,\n    mode: '100644',\n    type: 'blob',\n    sha: blob.sha\n\
          \  });\n}\n\n// Create new tree based on the base tree\nconsole.log(`Creating\
          \ tree with ${tree.length} modified files`);\nconst { data: newTree } =\
          \ await github.rest.git.createTree({\n  owner,\n  repo,\n  base_tree: baseCommit.tree.sha,\n\
          \  tree: tree\n});\n\n// Create commit\nconsole.log(`Creating commit`);\n\
          const { data: newCommit } = await github.rest.git.createCommit({\n  owner,\n\
          \  repo,\n  message: 'Apply repo. consistency fixes',\n  tree: newTree.sha,\n\
          \  parents: [baseSha]\n});\n\nconsole.log(`Created commit: ${newCommit.sha}`);\n\
          \n// Update branch ref\nconsole.log(`Updating ref heads/${branch} to ${newCommit.sha}`);\n\
          await github.rest.git.updateRef({\n  owner,\n  repo,\n  ref: `heads/${branch}`,\n\
          \  sha: newCommit.sha\n});\n\nconsole.log(`Successfully pushed commit to\
          \ ${branch}`);\n"
    - name: Prepare final comment message
      id: prepare_final_comment
      if: needs.init_comment_with_url.result == 'success'
      env:
        CHANGES_DETECTED: ${{ needs.run-repo-consistency-checks.outputs.changes_detected
          }}
      run: "if [ \"$CHANGES_DETECTED\" = 'true' ]; then\n  echo \"final_comment=Repo.\
        \ Consistency bot fixed some files and pushed the changes.\" >> $GITHUB_OUTPUT\n\
        else\n  echo \"final_comment=Repo. Consistency fix runs successfully without\
        \ any file modified.\" >> $GITHUB_OUTPUT\nfi\n"
    - name: Comment on PR
      if: needs.init_comment_with_url.result == 'success'
      uses: actions/github-script@v6
      env:
        PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}
      with:
        script: "const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\nawait github.rest.issues.updateComment({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  comment_id:\
          \ ${{ needs.init_comment_with_url.outputs.comment_id }},\n  body: `${{ steps.prepare_final_comment.outputs.final_comment\
          \ }}`\n});"
